@model topmeperp.Models.ContractModels
@{
    ViewBag.Title = "估驗請款單";
    Layout = "~/Views/Shared/_MenuLayout.cshtml";
    decimal? CurTotal = 0.0M;
    decimal? CurAmount = 0.0M;
}
<link href="~/Content/themes/base/jquery-ui.css" rel="stylesheet" />
<form id="formESTMain" name="formESTMain" action="" method="post" enctype="multipart/form-data" class="form-inline">
    <!--表頭-->
    <div class="contailer">
        <table class="table table-bordered">
            <tr class="bg-primary">
                <td colspan="3">@ViewBag.Title</td>
                <td width="10%">估驗次數</td>
                <td></td>
                <td width="10%">估驗日期</td>
                <td>
                    @if (null != @Model.planEST.CONTRACT_ID)
                    {
                    @Model.planEST.CREATE_DATE.Value.ToString("yyyy/MM/dd")
                    }
                </td>
            </tr>
            <tr class="bg-primary">
                <td width="10%">專案名稱</td>
                <td>
                    @Model.project.PROJECT_NAME (@Model.project.PROJECT_ID )
                </td>
                <td width="10%">憑單編號</td>
                <td>
                    @if (null != @Model.planEST.CONTRACT_ID)
                    {
                    @Model.planEST.EST_FORM_ID
                    }

                </td>
                <td>請款人</td>
                <td colspan="2">
                    @Model.supplier.COMPANY_NAME
                </td>
            </tr>
        </table>
        <input type="hidden" id="formId" name="formId" value="@Model.planEST.EST_FORM_ID" />
        <input type="hidden" id="projectId" name="projectId" value="@Model.project.PROJECT_ID" />
        <input type="hidden" id="contractId" name="contractId" value="@ViewBag.contracId" />
        <input type="hidden" id="supplierId" name="supplierId" value="@Model.supplier.SUPPLIER_ID" />
        <input type="hidden" id="prid_s" name="prid_s" value="@ViewBag.prid_s" />
        <input type="hidden" id="prid_e" name="prid_e" value="@ViewBag.prid_e" />
    </div>
    <!--請款明細資料-->
    <div class="contailer">
        <!--物料清單-->
        <table class="table" align="left">
            <thead>
                <tr class="bg-info">
                    <th>
                        No.
                    </th>
                    <th>
                        項次
                    </th>
                    <th>
                        項目說明
                    </th>
                    <th>
                        單位
                    </th>
                    <th>
                        合約數量
                    </th>
                    <th>
                        單價
                    </th>
                    <th>
                        前期數量
                    </th>
                    <th>
                        本期數量
                    </th>
                    <th>
                        本期金額
                    </th>
                    <th>
                        累計數量
                    </th>
                    <th>
                        累計金額
                    </th>
                    <th>
                        累計%
                    </th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.EstimationItems)
                {
                <tr>
                    <td>
                        @item.PLAN_ITEM_ID
                    </td>
                    <td>
                        @item.ITEM_ID
                    </td>
                    <td>
                        @item.ITEM_DESC
                    </td>
                    <td>
                        @item.ITEM_UNIT
                    </td>
                    <td>
                        @String.Format("{0:N2}", item.ITEM_QUANTITY)
                    </td>
                    <td>
                        @String.Format("{0:N0}", item.ITEM_UNIT_PRICE)
                    </td>
                    <td>
                        @String.Format("{0:N2}", item.PriorQty)
                    </td>
                    <td>
                        @String.Format("{0:N2}", item.EstimationQty)
                        @if (item.EstimationQty != null)
                            {
                                CurTotal = CurTotal + item.EstimationQty;
                            }
                    </td>
                    <td>
                        @String.Format("{0:N0}", item.EstimationAmount)
                        @if (item.EstimationQty != null)
                            {
                                CurAmount = CurAmount + item.EstimationAmount;
                            }
                    </td>
                    <td>
                        @String.Format("{0:N2}", ((item.PriorQty == null ? 0 : item.PriorQty) + item.EstimationQty))
                    </td>
                    <td>
                        @String.Format("{0:N0}", ((item.PriorQty == null ? 0 : item.PriorQty) + item.EstimationQty) * item.ITEM_UNIT_PRICE)
                    </td>
                    <th>
                        @String.Format("{0:N2}", ((item.PriorQty == null ? 0 : item.PriorQty) + item.EstimationQty) / item.ITEM_QUANTITY * 100) %
                    </th>
                </tr>
                }
            </tbody>
            <tfoot>
                <tr class="bg-success">
                    <th colspan="7" style="text-align:right">
                        合計
                    </th>
                    <th>
                        @String.Format("{0:N2}", @CurTotal)
                    </th>
                    <th>
                        @String.Format("{0:N0}", @CurAmount)
                    </th>
                    <th colspan="3">
                    </th>
                </tr>
            </tfoot>
        </table>
    </div>
    <!--憑證資料-->
    <div class="contailer">
        <!--由業管人員輸入-->
        <label>請款憑證資料</label>
        <input type="button" class="btn btn btn-warning" id="addInvoicerow" value="新增" />
        <table class="table Invoice-list">
            <thead>
                <tr class="bg-info">
                    <th>功能</th>
                    <th>憑證號碼</th>
                    <th>憑證日期</th>
                    <th>憑證金額</th>
                    <th>稅金</th>
                    <th>憑證類型</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <!--代付資料彙整-->
    <div class="contailer">
        Html.RenderPartial("_PaymentDetails");
    </div>

    <div class="row">
@*
        <div class="col-md-3">
           <!--依據現有估驗單
        @if (Model.planEST.STATUS == 0)
        {
            <button class="btn btn-default" id="updateForm" name="updateForm" type="button">儲存</button>
            <button class="btn btn-warning" type="button" onclick="createFlow()">送審</button>
            <button class="btn btn-danger" type="button" onclick="delEstimationOrder()">刪除</button>
        }-->
        <button class="btn btn-success" type="button" onclick="javascript:window.close()">離開</button>
    </div>
*@
        <!--依據流程任務與部門設定功能-->
        @Html.Partial("~/Views/include/_WorkFlowFunction.cshtml")
    </div>
</form>

<script type="text/javascript">
    $(document).ready(function () {
        //請款憑證明細資料
        var counterInvoice = 0;
        $("#addInvoicerow").on("click", function () {
            var newRow = $("<tr>");
            var cols = "";
            cols += '<td><input type="button" class="ibtnDelInvoice btn btn-md btn-danger"  value="刪除" /></td>';
            cols += '<td><input type="text" id="invoiceNo.' + counterInvoice + '" name="invoiceNo" class="form-control" autocomplete="off" style="max-width:none;width:100%" /></td>';
            cols += '<td><input type="date" id="invoiceDate.' + counterInvoice + '" name="invoiceDate" class="form-control" style="max-width:none;width:90%" /></td>';
            cols += '<td><input type="text" id="inoviceAmt.' + counterInvoice + '" name="invoiceAmt" class="form-control" style="max-width:none;width:90%"  /></td>';
            cols += '<td><input type="text" id="inoviceTax.' + counterInvoice + '" name="invoiceTax" class="form-control" style="max-width:none;width:90%"  /></td>';
            cols += '<td>';
            cols += '<select class="form-control" id="invoicetype.' + counterInvoice + '" name="invoicetype" required><option value="二聯式">二聯式</option><option value="三聯式">三聯式</option><option value="收據">收據</option><option value="工資單">工資單</option><option value="對開發票">對開發票</option><option value="折讓單">折讓單</option><option value="其他扣款">其他扣款</option></select>';
            cols += '</td>';
            cols += '</tr>';
            newRow.append(cols);
            $("table.Invoice-list").append(newRow);
            counterInvoice++;
        });

        $("table.Invoice-list").on("click", ".ibtnDelInvoice", function (event) {
            $(this).closest("tr").remove();
            counterInvoice -= 1
        });

    });
    //建立或修改估驗單資料
    $("#updateForm").click(function () {
        //console.log("send estimation order !!");
        //$.ajax({
        //    url: '/Estimation/saveEstimationOrder',
        //    data: $('#formESTMain').serialize(),
        //    type: "POST",
        //    dataType: 'text',
        //    success: function (msg) {
        //        ///alert(msg);
        //        window.location.href = "/Estimation/createEstimationOrderInfo?formid=" + msg;
        //    },
        //    error: function (xhr, ajaxOptions, thrownError) {
        //        alert(thrownError);
        //    }
        //})
    });
    //退件
    $("#RejectForm").click(function () {
        alert("退件Click");
        @*$.ajax({
            url: '@Url.Action("RejectForm", "CashFlow")',
            data: $('#formExpense').serialize(),
            type: "POST",
            dataType: 'text',
            success: function (msg) {
                alert(msg);
                window.location.replace("/CashFlow/ExpenseForm");
            },
            error: function (xhr, ajaxOptions, thrownError) {
                alert(thrownError);
            }
        });*@
    });
    //中止
    $("#CancelForm").click(function () {
        alert("中止Click");
        @*$.ajax({
            url: '@Url.Action("CancelForm", "CashFlow")',
            data: $('#formExpense').serialize(),
            type: "POST",
            dataType: 'text',
            success: function (msg) {
                alert(msg);
                window.location.replace("/CashFlow/ExpenseForm");
            },
            error: function (xhr, ajaxOptions, thrownError) {
                alert(thrownError);
            }
        });*@
    });
</script>
<style>
    .typeahead {
        position: sticky;
    }
</style>
