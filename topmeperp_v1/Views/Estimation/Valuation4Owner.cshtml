
@{
    ViewBag.Title = "業主計價";
    Layout = "~/Views/Shared/_MenuLayout.cshtml";
}
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.0rc1/angular.min.js"></script>

<h3 style="padding-bottom:5px;">業主估驗計價 :</h3>
<div ng-app="">
    @using (Html.BeginForm("AddVAForm", "Estimation", new { ReturnUrl = ViewBag.ReturnUrl }, FormMethod.Post, new { enctype = "multipart/form-data" }))
    {
        <div class="jumbotron">
            <div class="row">
                <div class="col-md-3 form-group">
                    <label for="id">專案編號:</label><input id="id" name="id" type="text" value="@ViewBag.projectid" class="form-control" style="background-color:#cccccc; width:100px;" readonly="readonly" />
                </div>
                <div class="col-md-4">
                    <label for="projectName">專案名稱:</label><input id="projectName" name="projectName" type="text" value="@ViewBag.projectName" class="form-control" style="background-color:#cccccc; width:250px;" readonly="readonly" />
                </div>
                <div class="col-md-1">
                    <div id="divProcessing">
                        <img src="~/Content/ajax-loader.gif">
                    </div>
                </div>
                <div class="col-md-3">
                    <a class="btn btn-link" href="/Tender/downLoadProjectItem?projectid=@ViewBag.projectid" target="_blank">下載範本</a>
                    <button class="btn btn-link" data-toggle="modal" data-target="#formUploadItem" type="button">上傳計價項目</button>
                </div>
                <div class="col-md-1">
                    <input type="button" class="btn btn-success" onclick="history.back()" value="回上一頁">
                </div>
            </div>
        </div>
        <div class="contailer" ng-controller="myController">
            @ViewBag.SearchResult
            <table class="table">
                <thead>
                    <tr>
                        <th>
                            功能
                        </th>
                        <th>
                            項次
                        </th>
                        <th>
                            工程項目
                        </th>
                        <th>
                            分項計價比例(%)
                        </th>
                        <th>
                            說明
                        </th>
                        <th>
                            合約金額(未稅)
                        </th>
                        <th>
                            <input type="checkbox" name="CheckAll" id="CheckAll">全選
                        </th>
                        <th>
                            本期請款金額
                        </th>
                        <th>
                            前期累計比例
                        </th>
                        <th>
                            累計請款金額
                        </th>
                        <th>
                            累計請款比例
                        </th>
                        <th>
                            未請款金額
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr ng-repeat="row in item">
                        <td>
                            <button type="button" class="btn btn-default btn-xs" onclick="getVAItem({{row.ITEN_NO}})">
                                <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>
                            </button>
                        </td>
                        <td>
                            <input style="width:50px" type="text" class="form-control" name="itemno" id="itemno" value="{{row.ITEN_NO}}" readonly="readonly" />
                        </td>
                        <td>
                            {{row.ITEM_DESC}}
                        </td>
                        <td>
                            {{row.ITEM_VALUATION_RATIO}}
                        </td>
                        <td>
                            {{row.REMARK}}
                        </td>
                        <td>
                            {{row.ITEM_REVENUE | number : 0}}
                        </td>
                        <td>
                            <input type="checkbox" id="chkItem" name="chkItem" value="{{row.ITEN_NO}}" />
                        </td>
                        <td>
                            <input style="width:100px" type="text" class="form-control" ng-model="row.evaluated_amount" id="evaluated_amount" ng-init="row.evaluated_amount =''" name="evaluated_amount">
                        </td>
                        <td>
                            {{row.EARLY_CUM_RATIO}}
                        </td>
                        <td>
                            {{row.EARLY_CUM_AMOUNT + row.evaluated_amount  | number : 0}}
                        </td>
                        <td>
                            {{(row.EARLY_CUM_AMOUNT + row.evaluated_amount) / row.ITEM_REVENUE * 100 * row.ITEM_VALUATION_RATIO / 100 | number : 2}}
                        </td>
                        <td>
                            {{row.ITEM_REVENUE - row.EARLY_CUM_AMOUNT - row.evaluated_amount  | number : 0}}
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="row">
            <div class="col-md-12">
                <input type="submit" value="新增" class="btn btn-warning" onclick="return Confirm_Form()" />
            </div>
        </div>
    }

</div>
<!-- Modal :對話框 上傳檔案-->
<div class="modal fade" id="formUploadItem" role="dialog">
    <div class="modal-dialog" id="formUploadItem">
        <div class="modal-content">
            <form id="formFileUpload" name="formFileUpload" action="/Estimation/uploadVAItem4Owner" method="post" enctype="multipart/form-data">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">上傳計價項目</h4>
                </div>
                <div class="modal-body form-group">
                    <input id="id" name="id" type="text" value="@ViewBag.projectid" class="form-control" style="background-color:#cccccc;" readonly="readonly" />
                    <input type="file" name="fileValuation" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal">關閉</button>
                    <input type="button" class="btn btn-default" data-dismiss="modal" value="上傳" onclick="uploadVAItem4Owner()" />
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Modal :修改計價項目對話框-->
<div class="modal fade" id="VAItem" role="dialog">
    <div class="modal-dialog" id="VAItemDialog">
        <!-- Modal content-->
        @Html.Partial("_VAItem");
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function () {
        // Hide the "busy" Gif at load:
        $("#divProcessing").hide();
        $("#CheckAll").click(function () {
            if ($("#CheckAll").prop("checked")) {
                $("input[name='chkItem']").prop("checked", true);
            } else
                $("input[name='chkItem']").prop("checked", false);
        });
    });

    function uploadVAItem4Owner() {
        $("#divProcessing").show();
        $("#formFileUpload").submit(function (e) {
            var formObj = $(this);
            var formURL = formObj.attr("action");
            var formData = new FormData(this);
            $.ajax({
                url: formURL,
                type: 'POST',
                data: formData,
                mimeType: "multipart/form-data",
                contentType: false,
                cache: false,
                processData: false,
                success: function (data, textStatus, jqXHR) {
                    alert(data);
                    $("#divProcessing").hide();
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    alert(jqXHR);
                    $("#divProcessing").hide();
                }
            });
            e.preventDefault(); //Prevent Default action.
            e.unbind();
        });
        $("#formFileUpload").submit(); //Submit the form
        // document.forms["formFileUpload"].submit();
    }
        //由ITEM_NO 取得資料填入表單
        function getVAItem(itemid) {
            //alert(userid);
            $.ajax({
                url: "/Estimation/getVAItem",
                type: "GET",
                data: { itemid: itemid },
                dataType: "JSON",
                success: function (data) {
                    $('#project_id').val(data.PROJECT_ID);
                    $('#item_no').val(data.ITEN_NO);
                    $('#item_desc').val(data.ITEM_DESC);
                    $('#item_valuation_ratio').val(data.ITEM_VALUATION_RATIO);
                    $('#remark').val(data.REMARK);
                    $('#VAItem').modal('show'); // show bootstrap modal when complete loaded
                    //$('.modal-title').text('編輯設定資料'); // Set title to Bootstrap modal title
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    alert('Error get data from ajax');
                }
            });
        }

        //更新va item
        $("#saveVAItem").click(function () {
            var s = $('#formVAItem').serialize();
            var URLs = "/Estimation/addVAItem";
            $.ajax({
                url: URLs,
                data: $('#formVAItem').serialize(),
                type: "POST",
                dataType: 'text',
                success: function (msg) {
                    alert(msg);
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    alert(thrownError);
                }
            });
        });
    
</script>
<script type="text/javascript">

    function myController($scope, $http) {
        //若資料量很多的話，建議改用$http的Ajax方法撈資料指派給$scope的item成員
        $scope.item = @Html.Raw(ViewData["items"]);
    }
</script>
