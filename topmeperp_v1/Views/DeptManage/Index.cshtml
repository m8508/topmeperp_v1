@{
    ViewBag.Title = "部門資料管理";
    Layout = "~/Views/Shared/_MenuLayout.cshtml";
}
<link href="../../Content/bootstrap-treeview.css" rel="stylesheet" type="text/css">
<script type="text/javascript" src="../../Scripts/bootstrap-treeview.js"></script>
<!--搜尋條件區域-->
<div class="jumbotron">
    <div class="row form-group">
        <form name="formSearch" id="formSearch" class="form-inline">
            <div class="col-md-12">
                    <label for="deptName">部門名稱:</label>
                    <input id="deptName" name="deptName" type="text" class="form-control" />
                    <button class="btn btn-info" id="btnQuery" name="btnQuery">查詢</button>
                    <div id="divProcessing">
                        <img src="~/Content/ajax-loader.gif">
                    </div>
                    <button type="button" class="btn btn-warning" data-toggle="modal" data-target="#deptInfo" onclick="clearDialog()">新增</button>
                </div>
        </form>
    </div>

    <!-- Modal :對話框-->
    <div class="modal fade" id="deptInfo" role="dialog">
        <div class="modal-dialog" id="userInfoDialog">
            <!-- Modal content-->
            @Html.Partial("_Dept");
        </div>
    </div>
</div>
<!--帳號資料清單，透過AJAX 更新相關頁面資料-->

<!--樹狀圖區塊-->

<div class="col-md-12">
    <h2 id="deptTree">部門樹狀圖</h2>
    <div id="treeview" style="height:500px;overflow-x:auto;"></div>
</div>

<script type="text/javascript">
    var chkNodeId;
    var defaultData = [@Html.Raw(ViewBag.TreeString)];
    $('#treeview').treeview({
        data: defaultData,
        showIcon: false,
        showCheckbox: true,
        showTags: true,
        onNodeChecked: function (event, node) {
            $('#treeview').treeview('uncheckAll', { silent: true });
            $('#checkable-output').prepend('<p>' + node.text + ' was checked</p>');
            $('#treeview').treeview('checkNode', [node.nodeId, { silent: true }]);
            // chkNodeId = node.href;
            $('#checkNodeId').val(node.href);
            node.expanded= true;
        },
        onNodeUnchecked: function (event, node) {
            $('#checkable-output').prepend('<p>' + node.text + ' was unchecked</p>');
            $('#checkNodeId').val("");
        }
    });
    $('#treeview').treeview('expandAll', { levels: 3, silent: $('#chk-expand-silent').is(':checked') });


    $("#saveDept").click(function () {
        //Ajax 功能範例
        alert($('#formDept').serialize());
        //特殊JQuery 選擇器
        // if ($("form[name='formUser'] select[name='roles']").val() == "") { alert("請設定使用者角色!!"); return false; }
        var URLs = "addDepartment";
        $.ajax({
            url: URLs,
            data: $('#formDept').serialize(),
            type: "POST",
            dataType: 'text',
            success: function (msg) {
                alert(msg);
            },
            error: function (xhr, ajaxOptions, thrownError) {
                alert(thrownError);
            }
        });
    });
    // Hide the "busy" Gif at load:
    $("#divProcessing").hide();
    // Attach click handler to the submit button:
    $('#login').click(function () {
        $("#divProcessing").show();
    });
    //設定查詢Form
    $("#btnQuery").click(function () {
        //Ajax 功能範例
        var URLs = "Query";
        $.ajax({
            url: URLs,
            data: $('#formSearch').serialize(),
            type: "POST",
            dataType: 'html',
            success: function (result) {
                $("#deptList").html(result);
            },
            error: function (xhr, ajaxOptions, thrownError) {
                alert(thrownError);
            }
        });
    });
    //由ID 取得資料填入表單
    function getUser(userid) {
        //alert(userid);
        $.ajax({
            url: "getUser",
            type: "GET",
            data: { userid: userid },
            dataType: "JSON",
            success: function (data) {
                $('#u_userid').val(data.USER_ID);
                $('#u_name').val(data.USER_NAME);
                $('#u_password').val(data.PASSWORD);
                $('#u_confirmpwd').val(data.PASSWORD);
                $('#u_email').val(data.EMAIL);
                $('#u_tel').val(data.TEL);
                $('#u_tel_ext').val(data.TEL_EXT);
                $('#u_fax').val(data.FAX);
                $('#u_mobile').val(data.MOBILE);
                //使用Jqery selector 選定對話框內的droplist
                $('#formUser #roles').val(data.ROLE_ID);
                $('#userInfo').modal('show'); // show bootstrap modal when complete loaded
                //$('.modal-title').text('編輯設定資料'); // Set title to Bootstrap modal title
            },
            error: function (jqXHR, textStatus, errorThrown) {
                alert('Error get data from ajax');
            }
        });
    }
    function clearDialog() {
        $('#d_deptCode').val('');
        $('#d_deptName').val('');
        $('#d_desc').val('');
        //使用Jqery selector 選定對話框內的droplist
        $('#formDept #d_parentId').val('');
    }
</script>
